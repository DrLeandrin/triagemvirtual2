---
phase: 01-fundacao
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .env.local.example
  - lib/env.ts
  - lib/supabase/client.ts
  - lib/supabase/server.ts
  - lib/supabase/middleware.ts
  - lib/db/schema.sql
  - app/globals.css
  - types/database.types.ts
autonomous: true
user_setup:
  - service: supabase
    why: "Database, authentication, and storage backend"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY
        source: "Supabase Dashboard -> Settings -> API -> Project API keys -> anon public"
    dashboard_config:
      - task: "Create a new Supabase project"
        location: "https://supabase.com/dashboard -> New Project"
      - task: "Run schema.sql in SQL Editor after Plan 01 completes"
        location: "Supabase Dashboard -> SQL Editor -> New Query -> paste lib/db/schema.sql"
      - task: "Enable Auth Hook for custom access token (after running schema.sql)"
        location: "Supabase Dashboard -> Authentication -> Hooks -> Custom Access Token Hook -> select public.custom_access_token_hook"

must_haves:
  truths:
    - "Supabase client libraries are installed and importable"
    - "Environment variables are validated at build time"
    - "Three Supabase client factories exist for browser, server, and middleware contexts"
    - "Database schema SQL is ready to execute with all required tables"
    - "Design system tokens are defined in Tailwind CSS v4 format"
  artifacts:
    - path: "lib/supabase/client.ts"
      provides: "Browser Supabase client factory"
      exports: ["createClient"]
    - path: "lib/supabase/server.ts"
      provides: "Server Supabase client factory"
      exports: ["createClient"]
    - path: "lib/supabase/middleware.ts"
      provides: "Middleware Supabase client with session refresh"
      exports: ["updateSession"]
    - path: "lib/env.ts"
      provides: "Zod-validated environment variables"
      exports: ["env"]
    - path: "lib/db/schema.sql"
      provides: "Complete database schema with RLS"
      contains: "create table public.patients"
    - path: "types/database.types.ts"
      provides: "TypeScript types for database tables"
      exports: ["Database", "Patient", "Doctor", "Consultation"]
    - path: ".env.local.example"
      provides: "Environment variable template"
      contains: "NEXT_PUBLIC_SUPABASE_URL"
  key_links:
    - from: "lib/supabase/client.ts"
      to: "lib/env.ts"
      via: "imports env vars"
      pattern: "process\\.env\\.NEXT_PUBLIC_SUPABASE"
    - from: "lib/supabase/server.ts"
      to: "next/headers"
      via: "cookie access for SSR auth"
      pattern: "cookies.*from.*next/headers"
    - from: "app/globals.css"
      to: "Tailwind v4 theme"
      via: "@theme directive"
      pattern: "@theme"
---

<objective>
Install Supabase dependencies, create all three Supabase client factories (browser, server, middleware), define the complete database schema SQL with RBAC and RLS, set up environment variable validation, and establish the Tailwind CSS v4 design system tokens.

Purpose: This is the foundation layer. Every other plan in Phase 1 depends on these Supabase clients, types, and design tokens existing.
Output: Supabase client utilities, database schema SQL file, TypeScript types, env validation, design system.
</objective>

<execution_context>
@C:\Users\leand\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\leand\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-funda-o-banco-de-dados-auth-e-layout-base/01-RESEARCH.md
@app/globals.css
@package.json
@tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, create Supabase clients, env validation, and TypeScript types</name>
  <files>
    .env.local.example
    lib/env.ts
    lib/supabase/client.ts
    lib/supabase/server.ts
    lib/supabase/middleware.ts
    types/database.types.ts
    package.json
  </files>
  <action>
1. Install packages:
   ```
   npm install @supabase/supabase-js @supabase/ssr zod jwt-decode
   ```

2. Create `.env.local.example` with placeholder values:
   ```
   NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
   NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=your-anon-key-here
   ```

3. Create `lib/env.ts` — Zod validation for environment variables. Export a validated `env` object. Schema must require `NEXT_PUBLIC_SUPABASE_URL` (z.string().url()) and `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY` (z.string().min(1)). Use `process.env` directly since NEXT_PUBLIC_ vars are available at build time.

4. Create `lib/supabase/client.ts` — Browser client factory using `createBrowserClient` from `@supabase/ssr`. Single export: `createClient()`. Uses `process.env.NEXT_PUBLIC_SUPABASE_URL!` and `process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!`.

5. Create `lib/supabase/server.ts` — Server client factory using `createServerClient` from `@supabase/ssr`. Uses `cookies()` from `next/headers` (must be awaited in Next.js 16). Implements `getAll()` and `setAll()` cookie handlers. The `setAll` must have try/catch wrapping `cookieStore.set()` since Server Components can't set cookies.

6. Create `lib/supabase/middleware.ts` — Export `updateSession(request: NextRequest)` function. Creates a Supabase server client with request cookie handlers that propagate cookies to both the request and the response. Calls `supabase.auth.getUser()` to refresh the session (use getUser() not getClaims() here since we just need session refresh, not validation). Returns `{ supabaseResponse, user }`. Follow the EXACT pattern from the research document.

7. Create `types/database.types.ts` — Manual TypeScript types for the database schema:
   - `AppRole` type: `'patient' | 'doctor' | 'admin'`
   - `Patient` interface: `id: string, user_id: string, full_name: string, cpf: string, birth_date: string | null, phone: string | null, created_at: string`
   - `Doctor` interface: `id: string, user_id: string, full_name: string, crm: string, specialty: string | null, created_at: string`
   - `Consultation` interface: `id: string, patient_id: string, doctor_id: string | null, status: 'waiting' | 'in_review' | 'contacted' | 'completed', transcript: string | null, summary: string | null, urgency: 'emergency' | 'urgent' | 'less_urgent' | 'non_urgent' | null, created_at: string, updated_at: string`
   - `UserRole` interface: `id: number, user_id: string, role: AppRole`
   - `Database` type mapping table names to Row types

IMPORTANT: Use `@/` path alias (configured in tsconfig.json as `"@/*": ["./*"]`). The project uses `app/` directory (NOT `src/app/`), so paths resolve from project root.
  </action>
  <verify>
    Run `npx tsc --noEmit` — must pass with no type errors. Verify all files exist with `ls lib/supabase/ lib/env.ts types/database.types.ts .env.local.example`.
  </verify>
  <done>
    All three Supabase client factories export createClient/updateSession. Environment validation schema exists. TypeScript types cover all database tables. .env.local.example documents required variables.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create database schema SQL and Tailwind design system</name>
  <files>
    lib/db/schema.sql
    app/globals.css
  </files>
  <action>
1. Create `lib/db/schema.sql` — Complete SQL schema to be run in Supabase SQL Editor. Include in this exact order:

   a. Create `app_role` enum: `create type public.app_role as enum ('patient', 'doctor', 'admin');`

   b. Create `user_roles` table: `id bigint generated by default as identity primary key`, `user_id uuid references auth.users on delete cascade not null`, `role app_role not null`, `unique(user_id, role)`.

   c. Create `custom_access_token_hook` function — PL/pgSQL function that reads user role from `user_roles` table and injects it into JWT claims as `user_role`. Use the EXACT pattern from research (stable, language plpgsql, returns jsonb).

   d. Grant permissions for Auth Hook: `grant usage on schema public to supabase_auth_admin`, grant execute on the hook function to `supabase_auth_admin`, revoke from authenticated/anon/public. Grant all on `user_roles` to `supabase_auth_admin`, revoke from authenticated/anon/public. Create RLS policy allowing `supabase_auth_admin` to select from `user_roles`.

   e. Create `authorize(requested_role app_role)` helper function — reads `user_role` from `auth.jwt()` claims and compares. Returns boolean. Use `security definer` and `set search_path = ''`.

   f. Create `patients` table: `id uuid default gen_random_uuid() primary key`, `user_id uuid references auth.users not null unique`, `full_name text not null`, `cpf text unique not null`, `birth_date date`, `phone text`, `created_at timestamptz default now() not null`. Enable RLS. Policies: select/insert/update where `auth.uid() = user_id`. Doctors can also select all patients via `authorize('doctor')`.

   g. Create `doctors` table: `id uuid default gen_random_uuid() primary key`, `user_id uuid references auth.users not null unique`, `full_name text not null`, `crm text unique not null`, `specialty text`, `created_at timestamptz default now() not null`. Enable RLS. Policy: select where `authorize('doctor')` (doctors can see each other). Insert/update where `auth.uid() = user_id`.

   h. Create `consultation_status` enum: `'waiting', 'in_review', 'contacted', 'completed'`.

   i. Create `urgency_level` enum: `'emergency', 'urgent', 'less_urgent', 'non_urgent'`.

   j. Create `consultations` table: `id uuid default gen_random_uuid() primary key`, `patient_id uuid references patients(id) not null`, `doctor_id uuid references doctors(id)`, `status consultation_status default 'waiting' not null`, `transcript text`, `summary jsonb`, `urgency urgency_level`, `hypotheses jsonb`, `created_at timestamptz default now() not null`, `updated_at timestamptz default now() not null`. Enable RLS. Policies: patients can select their own (`auth.uid() = (select user_id from patients where id = patient_id)`), doctors can select all (`authorize('doctor')`), doctors can update (`authorize('doctor')`).

   k. Create `updated_at` trigger function and apply to consultations table.

   l. Add SQL comments documenting that the Auth Hook must be enabled manually in Supabase Dashboard after running this script.

2. Update `app/globals.css` — Replace the default Next.js boilerplate with medical-themed design tokens using Tailwind CSS v4 `@theme` directive:

   ```css
   @import "tailwindcss";

   @theme {
     --color-primary: #2563eb;
     --color-primary-light: #3b82f6;
     --color-primary-dark: #1d4ed8;
     --color-secondary: #0891b2;
     --color-secondary-light: #06b6d4;
     --color-accent: #8b5cf6;
     --color-success: #16a34a;
     --color-warning: #d97706;
     --color-danger: #dc2626;

     --color-urgency-emergency: #dc2626;
     --color-urgency-urgent: #ea580c;
     --color-urgency-less-urgent: #d97706;
     --color-urgency-non-urgent: #16a34a;

     --color-surface: #ffffff;
     --color-surface-secondary: #f8fafc;
     --color-surface-dark: #0f172a;
     --color-text-primary: #0f172a;
     --color-text-secondary: #475569;
     --color-text-muted: #94a3b8;
     --color-border: #e2e8f0;

     --font-sans: var(--font-geist-sans), system-ui, -apple-system, sans-serif;
     --font-mono: var(--font-geist-mono), 'Courier New', monospace;
   }

   body {
     background: var(--color-surface);
     color: var(--color-text-primary);
   }
   ```

   Keep `@import "tailwindcss"` at the top. Remove the old `:root` and `@media (prefers-color-scheme: dark)` blocks. The medical app will not have dark mode in v1 (keep it simple). Use blue primary for trust/medical feel, urgency colors for triage classification.
  </action>
  <verify>
    Verify schema.sql is valid SQL by checking it has no syntax markers or placeholders. Run `npx next build` to confirm globals.css compiles correctly with Tailwind v4 (build may fail for other reasons but CSS should not error). Verify `lib/db/schema.sql` contains all tables: patients, doctors, consultations, user_roles.
  </verify>
  <done>
    schema.sql contains complete database definition with RLS enabled on all tables, RBAC Auth Hook function, authorize helper, and all policies. globals.css defines medical-themed design tokens via Tailwind v4 @theme including urgency colors.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- All files exist: lib/supabase/{client,server,middleware}.ts, lib/env.ts, lib/db/schema.sql, types/database.types.ts, .env.local.example
- globals.css contains @theme with medical design tokens
- schema.sql contains CREATE TABLE for patients, doctors, consultations, user_roles
- schema.sql contains ALTER TABLE ... ENABLE ROW LEVEL SECURITY for all tables
- schema.sql contains custom_access_token_hook function
</verification>

<success_criteria>
- Supabase packages installed (@supabase/supabase-js, @supabase/ssr, zod, jwt-decode)
- Three Supabase client factories ready for use by downstream plans
- Database schema ready to execute in Supabase SQL Editor
- TypeScript types match database schema
- Design system tokens defined and compilable
- Environment variable template exists
</success_criteria>

<output>
After completion, create `.planning/phases/01-funda-o-banco-de-dados-auth-e-layout-base/01-01-SUMMARY.md`
</output>
