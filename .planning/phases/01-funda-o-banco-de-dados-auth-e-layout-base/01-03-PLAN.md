---
phase: 01-fundacao
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - app/proxy.ts
  - app/(patient)/layout.tsx
  - app/(patient)/dashboard/page.tsx
  - app/(doctor)/layout.tsx
  - app/(doctor)/dashboard/page.tsx
  - app/layout.tsx
  - app/page.tsx
  - components/layout/patient-header.tsx
  - components/layout/doctor-sidebar.tsx
  - components/layout/sign-out-button.tsx
autonomous: true

must_haves:
  truths:
    - "Unauthenticated users accessing /patient/* or /doctor/* are redirected to /login"
    - "Patients accessing /doctor/* are redirected to /patient/dashboard"
    - "Doctors accessing /patient/* are redirected to /doctor/dashboard"
    - "Patient layout shows a header with navigation"
    - "Doctor layout shows a sidebar with navigation"
    - "Users can sign out from any protected page"
    - "Root page (/) redirects to appropriate dashboard based on role or to /login"
  artifacts:
    - path: "app/proxy.ts"
      provides: "Route protection middleware with role-based redirects"
      exports: ["proxy", "config"]
    - path: "app/(patient)/layout.tsx"
      provides: "Patient area layout with header navigation"
      min_lines: 20
    - path: "app/(patient)/dashboard/page.tsx"
      provides: "Patient dashboard placeholder page"
      min_lines: 10
    - path: "app/(doctor)/layout.tsx"
      provides: "Doctor area layout with sidebar navigation"
      min_lines: 20
    - path: "app/(doctor)/dashboard/page.tsx"
      provides: "Doctor dashboard placeholder page"
      min_lines: 10
    - path: "components/layout/patient-header.tsx"
      provides: "Patient navigation header component"
      min_lines: 20
    - path: "components/layout/doctor-sidebar.tsx"
      provides: "Doctor navigation sidebar component"
      min_lines: 25
    - path: "components/layout/sign-out-button.tsx"
      provides: "Sign out button with Supabase auth"
      min_lines: 10
  key_links:
    - from: "app/proxy.ts"
      to: "lib/supabase/middleware.ts"
      via: "calls updateSession for token refresh and user info"
      pattern: "updateSession.*from.*@/lib/supabase/middleware"
    - from: "app/proxy.ts"
      to: "jwt-decode"
      via: "decodes JWT to read user_role claim"
      pattern: "jwtDecode|jwt_decode"
    - from: "components/layout/sign-out-button.tsx"
      to: "lib/supabase/client.ts"
      via: "calls supabase.auth.signOut()"
      pattern: "signOut"
    - from: "app/(patient)/layout.tsx"
      to: "components/layout/patient-header.tsx"
      via: "renders header component"
      pattern: "PatientHeader"
    - from: "app/(doctor)/layout.tsx"
      to: "components/layout/doctor-sidebar.tsx"
      via: "renders sidebar component"
      pattern: "DoctorSidebar"
---

<objective>
Implement route protection via Next.js 16 proxy.ts with role-based access control, create patient and doctor area layouts with navigation components, and update the root page to redirect based on auth state.

Purpose: This completes the Phase 1 foundation. Users are directed to the correct area based on their role, unauthorized access is blocked, and each area has a distinct navigation pattern (header for patients, sidebar for doctors).
Output: Working route protection, role-based layouts, navigation components, sign-out functionality.
</objective>

<execution_context>
@C:\Users\leand\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\leand\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-funda-o-banco-de-dados-auth-e-layout-base/01-RESEARCH.md
@.planning/phases/01-funda-o-banco-de-dados-auth-e-layout-base/01-01-SUMMARY.md
@.planning/phases/01-funda-o-banco-de-dados-auth-e-layout-base/01-02-SUMMARY.md
@lib/supabase/middleware.ts
@lib/supabase/client.ts
@lib/supabase/server.ts
@types/database.types.ts
@app/globals.css
@app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create proxy.ts for route protection with role-based redirects</name>
  <files>
    app/proxy.ts
    app/page.tsx
    app/layout.tsx
  </files>
  <action>
1. Create `app/proxy.ts` — Next.js 16 middleware (replaces middleware.ts). This file runs on Node.js runtime (NOT Edge).

   Export `proxy` function accepting `NextRequest`:
   a. Call `updateSession(request)` from `@/lib/supabase/middleware` to refresh tokens and get user
   b. Get `pathname` from `request.nextUrl.pathname`

   Route protection logic:
   - **Public routes** (no protection): `/login`, `/signup`, `/auth/callback`, `/_next`, `/favicon.ico`, static assets
   - If pathname matches a public route, return `supabaseResponse` immediately

   - **Root path `/`**:
     - If no user: redirect to `/login`
     - If user exists: decode JWT with `jwtDecode` from `jwt-decode`, read `user_role` claim
     - If `user_role === 'doctor'`: redirect to `/doctor/dashboard`
     - Else: redirect to `/patient/dashboard`

   - **Patient routes `/patient/*`**:
     - If no user: redirect to `/login`
     - If user role is `doctor`: redirect to `/doctor/dashboard` (doctors should not be in patient area)
     - Else: return `supabaseResponse` (allow access)

   - **Doctor routes `/doctor/*`**:
     - If no user: redirect to `/login`
     - Decode JWT, check `user_role`
     - If role is NOT `doctor`: redirect to `/patient/dashboard` (patients cannot access doctor area)
     - Else: return `supabaseResponse` (allow access)

   - **All other routes**: If user exists, return `supabaseResponse`. If not, redirect to `/login`.

   Export `config` with matcher that excludes static files:
   ```
   matcher: ["/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)"]
   ```

   IMPORTANT: When decoding JWT, the user object from `updateSession` contains the session. Access the access_token to decode. If the user object structure from updateSession doesn't include access_token directly, use `supabase.auth.getSession()` inside the middleware client to get the token. Handle the case where jwt decode fails (no role claim) — default to patient behavior.

2. Update `app/page.tsx` — Replace the default Next.js boilerplate. Make it a server component that:
   - Creates Supabase server client
   - Calls `supabase.auth.getUser()`
   - If user: redirect to appropriate dashboard (proxy.ts handles this, but as a fallback)
   - If no user: redirect to `/login`
   - This page should basically never render — it just redirects

3. Update `app/layout.tsx` — Update the root layout:
   - Change `<html lang="en">` to `<html lang="pt-BR">` (Portuguese locale)
   - Update metadata: title to "Triagem Virtual", description to "Sistema de triagem medica virtual com inteligencia artificial"
   - Keep the Geist fonts and antialiased class
   - Keep it minimal — route group layouts handle specific UI
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify no type errors. Verify proxy.ts exports `proxy` function and `config`. Verify page.tsx no longer contains Next.js boilerplate.
  </verify>
  <done>
    proxy.ts protects all routes with authentication check and role-based redirects. Root page redirects based on auth state. Root layout uses pt-BR locale and correct metadata.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create patient/doctor layouts with navigation components</name>
  <files>
    components/layout/sign-out-button.tsx
    components/layout/patient-header.tsx
    components/layout/doctor-sidebar.tsx
    app/(patient)/layout.tsx
    app/(patient)/dashboard/page.tsx
    app/(doctor)/layout.tsx
    app/(doctor)/dashboard/page.tsx
  </files>
  <action>
1. Create `components/layout/sign-out-button.tsx` — Client component (`'use client'`).
   - Creates browser Supabase client from `@/lib/supabase/client`
   - On click: calls `supabase.auth.signOut()` then `router.push('/login')` using `useRouter` from `next/navigation`
   - Renders a button with text "Sair"
   - Accepts optional `className` prop for styling flexibility
   - Style: text-text-secondary hover:text-danger transition

2. Create `components/layout/patient-header.tsx` — Server component (no 'use client').
   - Full-width header bar at top: `bg-surface border-b border-border`
   - Left side: App logo/name "Triagem Virtual" as text in text-primary font-semibold
   - Right side: SignOutButton component
   - Fixed height: h-16 with px-6 flex items-center justify-between
   - Navigation links (for future phases): "Inicio" (to /patient/dashboard), "Nova Triagem" (to /patient/triage — placeholder, will be built in Phase 3)
   - Links styled as `text-text-secondary hover:text-primary`
   - If this needs to be a client component due to SignOutButton, that's fine — make it client

3. Create `components/layout/doctor-sidebar.tsx` — Client component (`'use client'`).
   - Vertical sidebar: `w-64 bg-surface-dark text-white min-h-screen`
   - Top: App name "Triagem Virtual" with subtitle "Painel Medico" in white/muted
   - Navigation items as vertical list:
     - "Fila de Pacientes" (link to /doctor/dashboard — active in v1)
     - "Historico" (link to /doctor/history — placeholder for future)
     - "Configuracoes" (link to /doctor/settings — placeholder for future)
   - Each nav item: `px-4 py-3 rounded-lg hover:bg-white/10 transition` with icon placeholder (just text for now)
   - Use `usePathname()` from `next/navigation` to highlight active route
   - Bottom of sidebar: SignOutButton with white text variant
   - Style active item: `bg-white/10 text-white font-medium`

4. Create `app/(patient)/layout.tsx` — Server component. Layout for all patient routes:
   - Renders PatientHeader at top
   - Main content area below: `<main className="flex-1 px-6 py-8 max-w-5xl mx-auto w-full">{children}</main>`
   - Wrapper: `min-h-screen flex flex-col bg-surface-secondary`

5. Create `app/(patient)/dashboard/page.tsx` — Server component. Patient dashboard placeholder:
   - Heading: "Bem-vindo" (h1, text-2xl font-semibold)
   - Subtext: "Sua saude e nossa prioridade. Inicie uma nova triagem quando precisar."
   - Call-to-action button: "Iniciar Triagem" linking to `/patient/triage` (placeholder route for Phase 3)
   - Button styled: bg-primary text-white px-6 py-3 rounded-lg hover:bg-primary-dark
   - Card showing "Suas consultas recentes" with empty state message "Nenhuma consulta realizada ainda."
   - This is just the placeholder — real dashboard features come in later phases

6. Create `app/(doctor)/layout.tsx` — Server component. Layout for all doctor routes:
   - Horizontal flex container: sidebar on left, content on right
   - Renders DoctorSidebar on the left
   - Main content: `<main className="flex-1 px-8 py-8 bg-surface-secondary min-h-screen">{children}</main>`
   - Wrapper: `flex min-h-screen`

7. Create `app/(doctor)/dashboard/page.tsx` — Server component. Doctor dashboard placeholder:
   - Heading: "Fila de Pacientes" (h1, text-2xl font-semibold)
   - Subtext: "Pacientes aguardando revisao medica"
   - Empty state: "Nenhum paciente na fila no momento."
   - Card layout skeleton showing what it will look like (just placeholder cards with "Carregando..." text)
   - This is just the placeholder — real dashboard features come in Phase 6

All visible text in pt-BR. Use design tokens from globals.css (bg-primary, text-text-primary, etc.).
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify no type errors. Run `npm run build` to verify the entire app builds successfully (may need .env.local with dummy values for build). Verify all files exist in correct paths. Check that patient layout uses PatientHeader and doctor layout uses DoctorSidebar.
  </verify>
  <done>
    Patient area has header navigation layout. Doctor area has sidebar navigation layout. Both areas have placeholder dashboard pages. Sign-out functionality works from both areas. All navigation text in pt-BR.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npm run build` completes (with appropriate env vars)
- proxy.ts redirects unauthenticated users to /login
- proxy.ts blocks patients from /doctor/* routes
- proxy.ts blocks doctors from /patient/* routes
- Patient layout renders header + content area
- Doctor layout renders sidebar + content area
- Sign-out button present in both layouts
- Root page (/) redirects to /login or appropriate dashboard
- Root layout has lang="pt-BR"
- All visible text in pt-BR
</verification>

<success_criteria>
- Route protection works for all protected paths
- Role-based access control redirects users to correct areas
- Patient area has distinct header navigation layout
- Doctor area has distinct sidebar navigation layout
- Both areas have placeholder dashboard pages
- Sign-out works from both areas
- Root page redirects correctly
</success_criteria>

<output>
After completion, create `.planning/phases/01-funda-o-banco-de-dados-auth-e-layout-base/01-03-SUMMARY.md`
</output>
