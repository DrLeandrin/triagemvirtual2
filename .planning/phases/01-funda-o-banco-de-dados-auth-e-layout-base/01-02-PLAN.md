---
phase: 01-fundacao
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - app/(auth)/login/page.tsx
  - app/(auth)/login/actions.ts
  - app/(auth)/signup/page.tsx
  - app/(auth)/signup/actions.ts
  - app/auth/callback/route.ts
  - app/(auth)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Patient can see a signup form and submit email + password + full name + CPF"
    - "Patient can see a login form and submit email + password"
    - "Auth callback route handles email confirmation codes"
    - "Server actions call Supabase Auth and handle errors gracefully"
    - "After signup, user role is assigned as patient in user_roles table"
  artifacts:
    - path: "app/(auth)/login/page.tsx"
      provides: "Login page UI"
      min_lines: 30
    - path: "app/(auth)/login/actions.ts"
      provides: "Login server action"
      exports: ["login"]
    - path: "app/(auth)/signup/page.tsx"
      provides: "Signup page UI with patient registration fields"
      min_lines: 40
    - path: "app/(auth)/signup/actions.ts"
      provides: "Signup server action with role assignment"
      exports: ["signup"]
    - path: "app/auth/callback/route.ts"
      provides: "Email confirmation callback handler"
      exports: ["GET"]
    - path: "app/(auth)/layout.tsx"
      provides: "Centered auth layout wrapper"
      min_lines: 10
  key_links:
    - from: "app/(auth)/login/actions.ts"
      to: "lib/supabase/server.ts"
      via: "imports createClient for auth"
      pattern: "createClient.*from.*@/lib/supabase/server"
    - from: "app/(auth)/signup/actions.ts"
      to: "lib/supabase/server.ts"
      via: "imports createClient for auth + DB insert"
      pattern: "createClient.*from.*@/lib/supabase/server"
    - from: "app/auth/callback/route.ts"
      to: "lib/supabase/server.ts"
      via: "exchanges code for session"
      pattern: "exchangeCodeForSession"
---

<objective>
Create the complete authentication flow: login page, signup page (patient registration), server actions for both, and the email confirmation callback route. After signup, assign the patient role via user_roles table.

Purpose: This is the core auth functionality. Without working signup/login, no user can access the system. Route protection (Plan 03) depends on these auth flows existing.
Output: Working auth pages with server actions, role assignment on signup.
</objective>

<execution_context>
@C:\Users\leand\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\leand\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-funda-o-banco-de-dados-auth-e-layout-base/01-RESEARCH.md
@.planning/phases/01-funda-o-banco-de-dados-auth-e-layout-base/01-01-SUMMARY.md
@lib/supabase/server.ts
@lib/supabase/client.ts
@types/database.types.ts
@app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth layout and login page with server action</name>
  <files>
    app/(auth)/layout.tsx
    app/(auth)/login/page.tsx
    app/(auth)/login/actions.ts
  </files>
  <action>
1. Create `app/(auth)/layout.tsx` — A centered layout for auth pages. Server component. Renders children centered on screen with max-w-md container. Uses design tokens from globals.css (bg-surface-secondary, text-text-primary). Includes the app name "Triagem Virtual" as a heading above the form area. All visible text in pt-BR.

2. Create `app/(auth)/login/page.tsx` — Client component (`'use client'`). Contains a form with:
   - Email input (type="email", required, label "E-mail")
   - Password input (type="password", required, label "Senha")
   - Submit button "Entrar" — styled with bg-primary text-white rounded-lg padding
   - Error message display area (red text below form, shows if action returns error)
   - Link to "/signup" with text "Nao tem conta? Cadastre-se"
   - Uses `useActionState` from React 19 (NOT useFormState — that's deprecated in React 19). Import from 'react' directly.
   - The form action calls the `login` server action from `./actions`
   - Show loading state on submit button (disabled + "Entrando..." text while pending)
   - Use `useActionState(login, initialState)` pattern where initialState is `{ error: '' }`

3. Create `app/(auth)/login/actions.ts` — Server action (`'use server'`). Export `login` function:
   - Accepts `prevState: { error: string }` and `formData: FormData` (useActionState signature)
   - Extracts email and password from formData
   - Basic validation: both fields required, email format check
   - Creates Supabase server client via `createClient()` from `@/lib/supabase/server`
   - Calls `supabase.auth.signInWithPassword({ email, password })`
   - On error: return `{ error: 'E-mail ou senha incorretos' }` (pt-BR, generic message for security)
   - On success: `redirect('/patient/dashboard')` (default for patients, proxy.ts will handle doctor redirect later)
   - Import `redirect` from `next/navigation`

IMPORTANT: All user-facing text must be in pt-BR per project decisions. Code (variable names, comments) in English.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify no type errors. Verify files exist at expected paths. Check that login/actions.ts imports from `@/lib/supabase/server`.
  </verify>
  <done>
    Login page renders a form with email/password inputs. Server action authenticates via Supabase and redirects on success or shows error on failure. Auth layout centers content.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create signup page with server action and role assignment, plus auth callback</name>
  <files>
    app/(auth)/signup/page.tsx
    app/(auth)/signup/actions.ts
    app/auth/callback/route.ts
  </files>
  <action>
1. Create `app/(auth)/signup/page.tsx` — Client component (`'use client'`). Contains a form with:
   - Full name input (type="text", required, label "Nome completo")
   - CPF input (type="text", required, label "CPF", maxLength 14, placeholder "000.000.000-00")
   - Email input (type="email", required, label "E-mail")
   - Password input (type="password", required, minLength 6, label "Senha")
   - Password confirmation input (type="password", required, label "Confirmar senha")
   - Submit button "Criar conta" — same styling as login button
   - Error message display area
   - Success message area (for email confirmation message)
   - Link to "/login" with text "Ja tem conta? Faca login"
   - Uses `useActionState` from React 19 with initialState `{ error: '', success: '' }`
   - Show loading state on submit

2. Create `app/(auth)/signup/actions.ts` — Server action (`'use server'`). Export `signup` function:
   - Accepts `prevState: { error: string, success: string }` and `formData: FormData`
   - Extracts: email, password, confirmPassword, fullName, cpf
   - Validation:
     - All fields required
     - Password min 6 chars
     - Password === confirmPassword, else return `{ error: 'As senhas nao coincidem', success: '' }`
     - CPF basic format check (11 digits after removing dots/dash)
   - Creates Supabase server client
   - Calls `supabase.auth.signUp({ email, password, options: { data: { full_name: fullName } } })`
   - On auth error: return `{ error: error.message, success: '' }`
   - On success:
     a. Get the new user's ID from the signup response (`data.user?.id`)
     b. If user ID exists, insert into `patients` table: `supabase.from('patients').insert({ user_id: userId, full_name: fullName, cpf: cpfClean })`
     c. Insert into `user_roles` table: `supabase.from('user_roles').insert({ user_id: userId, role: 'patient' })`
     d. NOTE: These inserts may fail due to RLS if the user hasn't confirmed email yet. Two approaches:
        - Option A: Use `supabase.auth.admin` (requires service_role key — NOT available in client)
        - Option B (PREFERRED): Handle this in the auth callback route after email confirmation
     e. For now, store fullName and cpf in auth.users metadata via the `options.data` parameter, and do the DB inserts in the callback
     f. Return `{ error: '', success: 'Conta criada! Verifique seu e-mail para confirmar.' }`

3. Create `app/auth/callback/route.ts` — Route handler for email confirmation:
   - Export `GET` function accepting `Request`
   - Extract `code` and `next` parameters from URL searchParams
   - If code exists:
     a. Create Supabase server client
     b. Call `supabase.auth.exchangeCodeForSession(code)`
     c. If no error:
        - Get the user: `supabase.auth.getUser()`
        - Extract metadata (full_name, cpf) from `user.user_metadata`
        - Insert into `patients` table with user_id, full_name, cpf
        - Insert into `user_roles` table with user_id, role: 'patient'
        - Handle `forwardedHost` for production deployments (check x-forwarded-host header)
        - Redirect to `next` param or `/patient/dashboard`
     d. If error: redirect to `/login?error=Erro ao confirmar e-mail`
   - If no code: redirect to `/login?error=Codigo de confirmacao ausente`

IMPORTANT: The callback route handles both profile creation AND role assignment. This ensures the user is authenticated (email confirmed) before inserting data, avoiding RLS issues. All user-facing text in pt-BR.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify no type errors. Verify files exist. Check that signup/actions.ts stores metadata in signUp options.data. Check that callback/route.ts inserts into both patients and user_roles tables.
  </verify>
  <done>
    Signup page collects patient info (name, CPF, email, password). Server action creates Supabase auth user with metadata. Auth callback route confirms email, creates patient record, and assigns patient role. Error/success states display correctly in pt-BR.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- All auth files exist in correct route group structure
- Login action uses `signInWithPassword` and redirects on success
- Signup action uses `signUp` with user metadata
- Callback route uses `exchangeCodeForSession` and creates patient + role records
- All user-facing strings are in pt-BR
- Forms use `useActionState` from React 19 (not useFormState)
</verification>

<success_criteria>
- Login page renders at /login with email + password form
- Signup page renders at /signup with full registration form
- Server actions connect to Supabase Auth correctly
- Auth callback handles email confirmation and creates DB records
- Error messages display in Portuguese
- Loading states work on form submission
</success_criteria>

<output>
After completion, create `.planning/phases/01-funda-o-banco-de-dados-auth-e-layout-base/01-02-SUMMARY.md`
</output>
